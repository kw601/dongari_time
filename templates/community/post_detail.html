<!-- 게시글 상세 페이지 (경로 : 게시판 페이지에서 게시글 클릭 시) -->
{% extends 'base.html' %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/reset.css' %}" />
<link rel="stylesheet" href="{% static 'css/community/post_detail.css' %}" />

<div class="detail__container">
    <div class="detail__main">
        <div class="p_d_container">
            <div class="board_name_box">
                <a href="{% url 'community:post_list' board.id %}">{{ board.board_name }}</a>
            </div>
            <hr class="hr_2px">
            <div class="content__container">
                <div class="comment-author p_d_p">
                    <!-- 공지게시판일 경우 무조건 실명으로 표시 -->
                    {% if post.board_id.board_name == "공지게시판" %}
                    {{ post.user_id.name }}
                    {% elif post.user_id and not post.anonymous %}
                    {{ post.user_id.nickname }}
                    {% else %}
                    익명
                    {% endif %}
                </div>
                <div>{{ post.created_time }}</div>
                <h2 class="content__title">{{ post.title }}</h2>
                {% if post.image %}
                <div class="img__container"><img src="{{ post.image.surl }}" alt="Post Image" class="p_d_image"></div>
                {% endif %}
                <p class="p_d_p">{{ post.content }}</p>
                <div class="state__container">
                    <div class="state__content">
                        <div class="like__container">
                            <img src="/../../static/image/like__icon.png" alt="좋아요">
                        </div>
                        <span id="like__description" class="like__description">{{ likes_count }}</span>
                    </div>
                    <div class="state__content">
                        <div class="comment__container">
                            <img src="/../../static/image/comment__icon.png" alt="댓글">
                        </div>
                        <span class="comment__description">{{ comments.count }}</span>
                    </div>
                    <div class="state__content">
                        <div class="scrap__container">
                            <img src="/../../static/image/scrap__icon.png" alt="스크랩">
                        </div>
                        <span id="scrap__description" class="scrap__description">{{ scrap_count }}</span>                        
                    </div>
                </div>
                <div class="post-actions">
                    <button id="scrap-btn" data-post-id="{{ post.id }}">
                        {% if user in post.scraps.all %}스크랩 취소{% else %}스크랩{% endif %}
                    </button>
                    <button id="like-btn" data-post-id="{{ post.id }}" data-is-liked="{{ is_liked|lower }}">
                        {% if is_liked %}좋아요 취소{% else %}좋아요{% endif %}
                        <p id="like-count"></p>
                    </button>
                    {% if user == post.user_id %}
                    <form action="{% url 'community:delete_post' post.id %}" method="post">
                        {% csrf_token %}
                        <button type="submit" onclick="return confirm('정말로 이 게시글을 삭제하시겠습니까?')">게시글 삭제</button>
                    </form>
                    {% endif %}
                    {% if user.is_authenticated and user.is_admin %}
                    <form method="post" action="{% url 'community:toggle_pinned' board.id post.id %}">
                        {% csrf_token %}
                        {% if post.pinned %}
                        <button type="submit">게시글 고정 해제</button>
                        {% else %}
                        <button type="submit">게시글 고정</button>
                        {% endif %}
                    </form>
                    {% endif %}
                </div>
            </div>
            <hr class="hr_2px">
            <h3 class="p_d_h3">댓글</h3>
            <div class="p_d_comment_section">
                {% for comment in comments %}
                {% if not comment.parent_id %}
                <div class="p_d_comment">
                    <p class="p_d_comment_author">작성자:
                        <!-- 공지게시판일 경우 무조건 실명으로 표시 -->
                        {% if post.board_id.board_name == "공지게시판" %}
                        {{ comment.user_id.name }}
                        {% elif comment.user_id and not comment.anonymous %}
                        {{ comment.user_id.nickname }}
                        {% else %}
                        익명
                        {% endif %}
                        | 작성일시: {{ comment.created_time }}
                    </p>
                    <p>{{ comment.content }}</p>
                    {% if user == comment.user_id %}
                    <form action="{% url 'community:delete_comment' comment.id %}" method="post">
                        {% csrf_token %}
                        <button type="submit" onclick="return confirm('정말로 이 댓글을 삭제하시겠습니까?')">삭제</button>
                    </form>
                    {% endif %}
                    <div class="p_d_reply_section">
                        <!-- 대댓글 작성 폼 -->
                        <form class="reply-form" method="post" action="{% url 'community:create_comment' board.id post.id %}">
                            {% csrf_token %}
                            <textarea name="content" required></textarea>
                            <input type="checkbox" name="anonymous"> 익명
                            <input type="hidden" name="parent_id" value="{{ comment.id }}">
                            <button type="submit">대댓글 작성</button>
                        </form>
        
                        {% for reply in comments %}
                        {% if reply.parent_id == comment %}
                        <div class="p_d_comment_reply">
                            <p class="p_d_comment_author">작성자:
                                <!-- 공지게시판일 경우 무조건 실명으로 표시 -->
                                {% if post.board_id.board_name == "공지게시판" %}
                                {{ reply.user_id.name }}
                                {% elif reply.user_id and not reply.anonymous %}
                                {{ reply.user_id.nickname }}
                                {% else %}
                                익명
                                {% endif %}
                                | 작성일시: {{ reply.created_time }}
                            </p>
                            <p>{{ reply.content }}</p>
                            {% if user == reply.user_id %}
                            <form action="{% url 'community:delete_comment' reply.id %}" method="post">
                                {% csrf_token %}
                                <button type="submit" onclick="return confirm('정말로 이 댓글을 삭제하시겠습니까?')">삭제</button>
                            </form>
                            {% endif %}
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
                <hr>
                {% endif %}
                {% endfor %}
            </div>
            <hr class="hr_1px">
        </div>
        <h3 class="p_d_h3_comment">댓글 작성</h3>
        <form class="p_d_comment_form" method="post">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit">댓글 작성</button>
        </form>
        <a href="{% url 'community:post_list' board.id %}">게시판 목록</a>
        </div>
    <div class="best__container">
        <div class="board__title">베스트 게시글</div>
            <ul class="best__ul">
                {% for post in posts_best %}
                {% if post.liked_cnt >= 5 %}
                    <li class="best__li">
                        <div class="best__name"><a href="{% url 'community:post_detail' post.board_id.id post.id %}">{{ post.title }}</a></div>
                    </li>
                        {% endif %}
                {% endfor %}
            </ul>
    </div>
</div>

<script src="{% static 'js/community/post_detail.js' %}"></script>

{% endblock content %}