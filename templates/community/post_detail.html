<!-- 게시글 상세 페이지 (경로 : 게시판 페이지에서 게시글 클릭 시) -->
{% extends 'base.html' %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/community/post_detail.css' %}" />

<div class="p_d_container">
    <div class="board_name_box">
        <h1 class="p_d_h1">{{ board.board_name }}</h1>
    </div>
    <hr class="hr_2px">
    <h2 class="p_d_h2">{{ post.title }}</h2>
    {% if post.image %}
    <img src="{{ post.image.url }}" alt="Post Image" class="p_d_image">
    {% endif %}
    <p class="comment-author p_d_p">작성자:
        {% if post.user_id and not post.anonymous %}
        {{ post.user_id.nickname }}
        {% else %}
        익명
        {% endif %}
        | 작성일시: {{ post.created_time }}
    </p>
    <p class="p_d_p">{{ post.content }}</p>
    <p class="p_d_p">댓글: {{ comments.count }}</p>
    <div class="post-actions">

        {% if user.is_authenticated and user.is_admin %}
        <form method="post" action="{% url 'community:toggle_pinned' board.id post.id %}">
            {% csrf_token %}
            {% if post.pinned %}
            <button type="submit">게시글 고정 해제</button>
            {% else %}
            <button type="submit">게시글 고정</button>
            {% endif %}
        </form>
        {% endif %}

        <button id="scrap-btn" data-post-id="{{ post.id }}">
            {% if user in post.scraps.all %}스크랩 취소{% else %}스크랩{% endif %}
        </button>
        <button id="like-btn" data-post-id="{{ post.id }}">
            좋아요 <span id="like-count">{{ post.liked }}</span>
        </button>
    </div>
    <hr class="hr_2px">
    <h3 class="p_d_h3">댓글</h3>
    <div class="p_d_comment_section">
        {% for comment in comments %}
        {% if not comment.parent_id %}
            <div class="p_d_comment">
                <p class="p_d_comment_author">작성자:
                    {% if comment.user_id and not comment.anonymous %}
                    {{ comment.user_id.nickname }}
                    {% else %}
                    익명
                    {% endif %}
                    | 작성일시: {{ comment.created_time }}
                </p>
                <p>{{ comment.content }}</p>
                <div class="p_d_reply_section">
                    <!-- 대댓글 작성 폼 -->
                    <form class="reply-form" method="post" action="{% url 'community:create_comment' board.id post.id %}">
                        {% csrf_token %}
                        <textarea name="content" required></textarea>
                        <input type="checkbox" name="anonymous"> 익명
                        <input type="hidden" name="parent_id" value="{{ comment.id }}">
                        <button type="submit">대댓글 작성</button>
                    </form>
                    
                    {% for reply in comments %}
                        {% if reply.parent_id == comment %}
                        <div class="p_d_comment_reply">
                            <p class="p_d_comment_author">작성자:
                                {% if reply.user_id and not reply.anonymous %}
                                {{ reply.user_id.nickname }}
                                {% else %}
                                익명
                                {% endif %}
                                | 작성일시: {{ reply.created_time }}
                            </p>
                            <p>{{ reply.content }}</p>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            <hr>
            {% endif %}
        {% endfor %}
    </div>
        <hr class="hr_1px">
    </div>
    <h3 class="p_d_h3_comment">댓글 작성</h3>
    <form class="p_d_comment_form" method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit">댓글 작성</button>
    </form>
    <a href="{% url 'community:post_list' board.id %}">게시판 목록</a>
</div>

<script src="{% static 'js/community/post_detail.js' %}"></script>
    
{% endblock content %}